<!DOCTYPE html>
<html>
	
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
		<title>ChitChat-BuddyList</title>
		<style> @import url("../css/bottom.css"); </style>
		<link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.3.0/weui.min.css"/>
		<script type="text/javascript" src="../js/cookie.js"></script>
		<script type="text/javascript" src="../js/loadPic.js"></script>
		<style>
			[v-cloak] {
			  display: none;
			}
			.weui-cells__title{
				font-size: 1.35rem;
			}
			#portrait{
				position: relative;
				right: -80%;
			}
			.button{
				font-size: 1.35rem;
				position: fixed;
				right: 5%;
			}
		</style>
	</head>
	<body>
	<div id="app" v-cloak>
		

		<div class="weui-cells__title">
			通讯录
			<a href="javascript:" class="button" @click="switchSearchFriends">+</a>
		</div>
		<div class="weui-cells__title">  </div>

        <div class="weui-cells">
			<a class="weui-cell  weui-cell_access weui-cell_example" @click="switchNewFriend" href="javascript:">
                <div class="weui-cell__hd" style="position: relative;">
					<img src="../img/chat/chat_show.png" alt="" style="width: 40px; margin-right: 16px; display: block;">
					<span class="weui-badge" style="position: absolute; top: -0.4em; right: 0.6em;">8</span>
				</div>
                <div class="weui-cell__bd">
                    <p>新的朋友</p>
                </div>
            </a>
            <a class="weui-cell  weui-cell_access weui-cell_example" @click="switchRobot" href="javascript:">
                <div class="weui-cell__hd"><img src="../img/chat/chat_show.png" alt="" style="width: 40px; margin-right: 16px; display: block;"></div>
                <div class="weui-cell__bd">
                    <p>Bot</p>
                </div>
                <div class="weui-cell__ft"></div>
			</a>

			<h5 style="text-indent: 5%;">加入的聊天室</h5>
			<a class="weui-cell  weui-cell_access weui-cell_example" @click="switchChatroom(1)" href="javascript:">
                <div class="weui-cell__hd"><img src="../img/chat/chat_show.png" alt="" style="width: 40px; margin-right: 16px; display: block;"></div>
                <div class="weui-cell__bd">
                    <p>聊天室名称</p>
                </div>
                <div class="weui-cell__ft"></div>
			</a>
			<!--真正的聊天室-->
			<div v-for="(room, i) in roomList">
				<a class="weui-cell  weui-cell_access weui-cell_example" href="javascript:" @click="switchChatroom(room.rid)">
					<div class="weui-cell__hd">
						<img :src='getImg(user.uid)' alt="" style="width: 40px; margin-right: 16px; display: block;"></div>
					<div class="weui-cell__bd">
						<p> {{room.roomname}} </p>
					</div>
					<div class="weui-cell__ft"></div>
				</a>
			</div>
			<br>

			<h5 style="text-indent: 5%;">我的好友列表</h5>
			<a class="weui-cell  weui-cell_access weui-cell_example" @click="switchFriend(1)" href="javascript:">
                <div class="weui-cell__hd"><img src="../img/chat/chat_show.png" alt="" style="width: 40px; margin-right: 16px; display: block;"></div>
                <div class="weui-cell__bd">
                    <p>联系人名称</p>
                </div>
                <div class="weui-cell__ft"></div>
			</a>
			<!--真正的好友列表-->
			<div v-for="(user, i) in friendList">
				<a class="weui-cell  weui-cell_access weui-cell_example" href="javascript:" @click="switchFriend(user.uid)">
					<div class="weui-cell__hd">
						<img :src='getImg(user.uid)' alt="" style="width: 40px; margin-right: 16px; display: block;"></div>
					<div class="weui-cell__bd">
						<p> {{user.nickname}} </p>
					</div>
					<div class="weui-cell__ft"></div>
				</a>
			</div>
			
		</div>

		<div class="bottom_bar">
			<div class="bottom_bar1" v-bind:class="{whiten:ifBottom1}" @click="isBottomShow1">
				<img class="bottom_icon" src="../img/icon/message.png">
			</div>
			<div class="bottom_bar2" v-bind:class="{whiten:ifBottom2}" @click="isBottomShow2" >
				<img class="bottom_icon" src="../img/icon/mailList.png">
			</div>
			<div class="bottom_bar3" v-bind:class="{whiten:ifBottom3}" @click="isBottomShow3" >
				<img class="bottom_icon" src="../img/icon/mine.png">
			</div>
		</div>
	</div>	
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
		<script src="../js/sockjs-client.js"></script>
		<script src="../js/stomp.js"></script>
		<script>
			function subscribe() {
				client.subscribe('/uni/add/'+localStorage.getItem("uid"), onMessage);
			}
			var connectCallback = function() {
				console.log('连接成功!');
				client.subscribe('/uni/chat/' + localStorage.getItem("uid"), onMessage);
			};
			var errorCallback = function() {
				console.log('连接失败!');
			};
			var ws = new SockJS('http://129.211.62.153:8080/ws');
			var client = Stomp.over(ws);
			client.connect(localStorage.getItem("uid") + '', 'pass' + localStorage.getItem("uid"), connectCallback,
				errorCallback);
			function onMessage(message) {
				app.refresh();
			}
			window.toChat = function(type, id) {
				console.log(type, id)
				if (type == 1) {
					localStorage.setItem("nf", id);
					window.location.href = './friend.html';
				} else if (type == 2) {
					if (id != -1) localStorage.setItem("nr", id);
					window.location.href = './chatroom.html';
				}
			};
		var app = new Vue({
			el: "#app",
			data: {
				tempUID:'1',
				ifBottom1:false,
				ifBottom2:true,
				ifBottom3:false,
				uid:'',
				friendList:[],
				roomList:[],
			},
			mounted() {
				this.uid = localStorage.getItem("uid");
				axios.get('http://129.211.62.153:8080/user/getlist/'+this.uid+'/1')
				.then((res)=>{
					console.log(res);
					this.friendList = res.data;
				})
				axios.get('http://129.211.62.153:8080/user/getroom/'+this.uid)
				.then((res)=>{
					console.log(res);
					this.roomList = res.data;
				})
			},

			methods:{
				isBottomShow1:function(){
					window.location.href='./message.html';
				},
				isBottomShow2:function(){
					this.ifBottom1=false;
					this.ifBottom2=true;
					this.ifBottom3=false;
				},
				isBottomShow3:function(){
					window.location.href='./me.html';
				},
				switchRobot:function(){
					window.location.href='./robot.html';
				},
				switchNewFriend:function(){
					window.location.href='./newfriend.html';
				},
				switchFriend: function(uid) {
					localStorage.setItem("nf") = uid;
					window.location.href = './friend.html';
				},
				switchChatroom: function(uid) {
					localStorage.setItem("nr") = uid;
					window.location.href = './chatroom.html';
				},
				switchSearchFriends: function() {
					window.location.href = './searchFriend.html';
				},
				getImg(uid) {
                    var url = "http://129.211.62.153:8080/image/" + uid + "/head.jpg";
                    console.log(url);
                    return url;
                }
			}
		})
		</script>
	
	</body>
</html>
