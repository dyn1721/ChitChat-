<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
		<title>mainpage</title>
		<style> @import url("../css/bottom.css"); </style>
		<link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.3.0/weui.min.css" />
		<style>
			.weui-cells {
				margin: 0 0 0 0;
			}
			.weui-btn {
				color: #41abe2;
			}
			[v-cloak] {
			    display: none;
			}
		</style>
	</head>
	<body>
		<div id="app" v-cloak>
			<div class="top">
				<div class="top_pic">
					<img v-bind:src="portraitSrc" style="border-radius: 50%; width: 30px; height: 30px;">
				</div>
				<div class="top_name">
					<div style="display: table-cell; vertical-align: middle;">消 息</div>
				</div>
				<div class="top_more" @click="changeDialog">
					<img src="../img/chat/message_more_w.png" style="width: 40%;">
				</div>
			</div>
			<div id="middle" class="middle">
			</div>
			<div class="bottom_bar">
				<div class="bottom_bar1" v-bind:class="{whiten:ifBottom1}" @click="isBottomShow1">
					<img class="bottom_icon" src="../img/icon/message.png">
				</div>
				<div class="bottom_bar2" v-bind:class="{whiten:ifBottom2}" @click="isBottomShow2">
					<img class="bottom_icon" src="../img/icon/mailList.png">
				</div>
				<div class="bottom_bar3" v-bind:class="{whiten:ifBottom3}" @click="isBottomShow3">
					<img class="bottom_icon" src="../img/icon/mine.png">
				</div>
			</div>

			<div id="dialogs" v-show="dialog">
				<div class="js_dialog">
					<div class="weui-mask" @click="changeDialog"></div>
					<div class="weui-dialog weui-skin_android">
						<div class="weui-dialog__hd">
							<div class="weui-dialog__hd__main">
								<strong class="weui-dialog__title">创建群聊</strong>
							</div>
						</div>
						<div class="weui-cells">
							<div class="weui-cell weui-cell_active">
								<div class="weui-cell__bd">
									<input class="weui-input" id="text" type="text" placeholder="请输入群聊名称" />
								</div>
							</div>
						</div>
						<div class="weui-dialog__ft">
							<a href="javascript:" class="weui-dialog__btn weui-dialog__btn_default" @click="changeDialog">取消</a>
							<a href="javascript:" class="weui-dialog__btn weui-dialog__btn_warning" @click="createChatroom">确定</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script type="text/javascript">
			window.toChat = function(type, id) {
				console.log(type, id)
				if (type == 1) {
					localStorage.setItem("nf", id);
					window.location.href = './friend.html';
				} else if (type == 2) {
					localStorage.setItem("nr", id);
					window.location.href = './chatroom.html';
				}
			};
			var app = new Vue({
				el: "#app",
				data: {
					ifBottom1: true,
					ifBottom2: false,
					ifBottom3: false,
					username: '',
					useruid: '',
					portraitSrc: '',
					middleshow: '',
					dialog: false,
					chatname: '',
					chatid: '',
					massagelist: []
				},
				mounted() {
					this.username = document.cookie.split('=')[1];
					if (localStorage.getItem("username") == null) {
						axios.get('http://129.211.62.153:8080/user/searchByLoginID/' + this.username).then((res) => {
							console.log(res)
							var sign = res.data.intro;
							var email = res.data.email;
							if (sign == null)
								sign = ''
							if (email == null)
								email = ''
							localStorage.setItem("username", this.username);
							localStorage.setItem("nickname", res.data.nickname);
							localStorage.setItem("uid", res.data.uid);
							this.useruid = res.data.uid;
							localStorage.setItem("sex", res.data.sex);
							localStorage.setItem("age", res.data.age);
							localStorage.setItem("sign", sign);
							localStorage.setItem("email", email);
							//头像获取
							var picsrc = "http://129.211.62.153:8080/image/" + res.data.uid + "/head.jpg";
							localStorage.setItem("pic", picsrc);
							this.portraitSrc = picsrc
						})
					} else {
						this.portraitSrc = localStorage.getItem("pic");
						this.useruid = localStorage.getItem("uid");
					}
					this.middleshow = document.getElementById("middle");
					setTimeout(this.load, 500);
				},
				methods: {
					isBottomShow1: function() {
						this.ifBottom1 = true;
						this.ifBottom2 = false;
						this.ifBottom3 = false;
					},
					isBottomShow2: function() {
						window.location.href = './list.html';
					},
					isBottomShow3: function() {
						window.location.href = './me.html';
					},
					changeDialog: function() {
						this.dialog = !this.dialog;
						var text = document.getElementById('text');
						text.value = ''
					},
					load: function() {
						if (localStorage.getItem("mlist") == null) {
							axios.post('http://129.211.62.153:8080/msg/chatinfo/' + this.useruid).then((res) => {
								console.log(res);
								this.massagelist.push({
									type: "1",
									otheruid: "",
									selfuid: this.useruid,
									newMessageNumber: "",
									name: "",
									newestMessage: "",
									time: ""
								})
								localStorage["mlist"] = JSON.stringify(this.massagelist);
							})
						} else {
							this.refresh();
						}
						setTimeout(this.show, 500);
					},
					refresh: function() {
						axios.post('http://129.211.62.153:8080/msg/chatinfo/' + this.useruid).then((res) => {
							console.log(res.data);
							this.massagelist.push({
								type: 1,
								otheruid: 2,
								selfuid: this.useruid,
								newMessageNumber: 0,
								name: "测试",
								newestMessage: "测试",
								time: "2020-06-22-14-07-15"
							})
							localStorage["mlist"] = JSON.stringify(this.massagelist);
						})
					},
					show: function() {
						var i = 0;
						var li = JSON.parse(localStorage.getItem("mlist"));
						li.sort(this.compare('time'))
						console.log(li[0])
						for (; i < li.length; i++) {
							if (li[i].newMessageNumber != 0)
								this.middleshow.innerHTML +=
								'<div class="weui-cells" onclick="toChat(' + li[i].type + ',' + li[i].otheruid + ')">' +
								'<div class="weui-cell weui-cell_active">' +
								'<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">' +
								'<img src="../img/chat/chat_show.png" style="width: 50px; display: block;" />' +
								'<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;">' + li[i].newMessageNumber +
								'</span>' +
								'</div>' +
								'<div class="weui-cell__bd">' +
								'<p>' + li[i].name + '</p>' +
								'<p style="font-size: 13px; color: #888;">' + li[i].newestMessage + '</p>' +
								'</div>' +
								'<div class="weui-cell__ft">' + li[i].time + '</div>' +
								'</div>' +
								'</div>'
							else
								this.middleshow.innerHTML +=
								'<div class="weui-cells" onclick="toChat(' + li[i].type + ',' + li[i].otheruid + ')">' +
								'<div class="weui-cell weui-cell_active">' +
								'<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">' +
								'<img src="../img/chat/chat_show.png" style="width: 50px; display: block;" />' +
								'</div>' +
								'<div class="weui-cell__bd">' +
								'<p>' + li[i].name + '</p>' +
								'<p style="font-size: 13px; color: #888;">' + li[i].newestMessage + '</p>' +
								'</div>' +
								'<div class="weui-cell__ft">' + li[i].time + '</div>' +
								'</div>' +
								'</div>'
						}
					},
					createChatroom: function() {
						var text = document.getElementById('text');
						this.chatname = text.value;
						text.value = '';
						axios.get('http://129.211.62.153:8080/room/add/' + this.useruid + '/' + this.chatname).then((res) => {
							console.log(res);
							this.chatid = res.data;
							console.log(this.chatid);
						})
						// toChat(2, this.chatid);
					},
					compare(attr) {
						let that = this;
						return function(a, b) {
							let val1 = a[attr];
							let val2 = b[attr];
							val1 = this.changeDate(val1)
							val2 = this.changeDate(val2)
							return new Date(val2) - new Date(val1);
						}
					},
					changeDate: function(str) {
						str = str.replace(/-/, '/')
						str = str.replace(/-/, '/')
						str = str.replace(/-/, ' ')
						str = str.replace(/-/g, ':')
						return str;
					}
				}
			})
		</script>
	</body>
</html>
